<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>マッチ一覧</title>
    <!-- BootstrapのCSS読み込み -->
    <link href="../stylesheets/bootstrap.min.css" rel="stylesheet">
    <!-- totoSmash!のCSS読み込み -->
    <link href="../stylesheets/style.css" rel="stylesheet">
    <!-- jQuery読み込み -->
    <script src="../libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- BootstrapのJS読み込み -->
    <script src="../javascripts/bootstrap.min.js"></script>

    <script type="text/javascript">
    $(document).ready( function(){
        loadPoints();
    });
    function loadPoints(){
    	$.ajax({	
    		url:'query/<%= locals.inputId %>', // 通信先のURL
    		type:'GET',		// 使用するHTTPメソッド (GET/ POST)
    		data:'', // 送信するデータ
    		dataType:'text', // 応答のデータの種類 
    						// (xml/html/script/json/jsonp/text)
    		timeout:1000, 		// 通信のタイムアウトの設定(ミリ秒)

    		// 2. doneは、通信に成功した時に実行される
    		//  引数のdata1は、通信で取得したデータ
    		//  引数のtextStatusは、通信結果のステータス
    		//  引数のjqXHRは、XMLHttpRequestオブジェクト
    		}).done(function(data1,textStatus,jqXHR) {
                                console.log(jqXHR.status); //jqXHR.statusを表示
                                console.log(textStatus); //textStatusを表示

    				// 3. キーを指定して値を表示 
    				$("#myPoints").html(data1);

    				// 4. オブジェクトをJSON形式の文字列に変換
    				//var data2 = JSON.stringify(data1);
    				//console.log(data2); //コンソールにJSON形式で表示される


    		// 6. failは、通信に失敗した時に実行される
    		}).fail(function(jqXHR, textStatus, errorThrown ) {
                                console.log(jqXHR.status); //jqXHR.statusを表示
                                console.log(textStatus); //textStatusを表示
                                console.log(errorThrown); //errorThrownを表示

    		// 7. alwaysは、成功/失敗に関わらず実行される
    		}).always(function(){
                                console.log("complete"); //表示3
    				
    	});
    }
    </script>

  </head>
  <body>

<%- include('menu', {pageTitle:'マッチ一覧', pageUrl:'/TS/TSB001V02'}) %>

<div class="container">

    <p class="text-right"><%= locals.inputId %> さんの保有ポイント：<span id="myPoints"></span></span></p>
<% /*
  <div class="panel table-responsive">
    <div class="table-responsive">
      <table class="table">
        <!-- 1試合目 -->
        <tr>
          <th class="match-th">ATP St Petersburg</th>
          <th class="match-th text-center">1</th>
          <th class="match-th text-center">2</th>
        </tr>
        <tr>
          <td class="bg-success">Damir Dzumhur</td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player1" data-player="Damir Dzumhur">BET</button></td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player2" data-player="Liam Broady">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success">Liam Broady</td>
        </tr>
        
        <!-- 2試合目 -->
        <tr>
          <th class="match-th">WTA B-Con Plaza</th>
          <th class="match-th text-center">1</th>
          <th class="match-th text-center">2</th>
        </tr>
        <tr>
          <td class="bg-success">Kei Nishikori</td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player1" data-player="Kei Nishikori">BET</button></td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player2" data-player="Yuichi Sugita">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success">Yuichi Sugita</td>
        </tr>

        <!-- 3試合目 -->
        <tr>
          <th class="match-th">WTA Guangzhou</th>
          <th class="match-th text-center">1</th>
          <th class="match-th text-center">2</th>
        </tr>
        <tr>
          <td class="bg-success">Yanina Wickmayer</td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player1" data-player="Damir Dzumhur">BET</button></td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player2" data-player="Liam Broady">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success">Aleksandra Krunic</td>
        </tr>

        <!-- 4試合目 -->
        <tr>
          <th class="match-th">WTA Tokyo</th>
          <th class="match-th text-center">1</th>
          <th class="match-th text-center">2</th>
        </tr>
        <tr>
          <td class="bg-success">Caroline Wozniacki</td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player1" data-player="Damir Dzumhur">BET</button></td>
          <td rowspan="2" class="bg-success text-center" style="vertical-align:middle;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player2" data-player="Liam Broady">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success">Dominika Cibulkova</td>
        </tr>

      </table>
    </div><!-- table-responsive -->
  </div>
 */ %>


        <div id="alert" class="alert alert-info fade in" style="display:none;">
            <a href="#" class="close" data-dismiss="alert"
                aria-label="close">×</a>
           BET 完了しました 
        </div>

        <div id="alert_error" class="alert alert-danger fade in" style="display:none;">
            <a href="#" class="close" data-dismiss="alert"
                aria-label="close">×</a>
           BET 処理に失敗しました 
        </div>

  <div class="panel table-responsive">
    <div class="table-responsive">
      <table class="table">
        <!-- 1試合目 -->
        <tr>
          <th colspan="2" class="match-th">ATP St Petersburg</th>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Damir Dzumhur</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player2" data-player="Liam Broady">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Liam Broady</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player1" data-player="Damir Dzumhur">BET</button></td>
        </tr>

        <!-- 2試合目 -->
        <tr>
          <th colspan="2" class="match-th">WTA B-Con Plaza</th>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Kei Nishikori</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="Nishikori" data-player="Kei Nishikori">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Yuichi Sugita</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="Nadal" data-player="Yuichi Sugita">BET</button></td>
        </tr>

        <!-- 3試合目 -->
        <tr>
          <th colspan="2" class="match-th">WTA Guangzhou</th>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Yanina Wickmayer</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player2" data-player="Liam Broady">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Aleksandra Krunic</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player1" data-player="Damir Dzumhur">BET</button></td>
        </tr>

        <!-- 4試合目 -->
        <tr>
          <th colspan="2" class="match-th">WTA Tokyo</th>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Caroline Wozniacki</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player2" data-player="Liam Broady">BET</button></td>
        </tr>
        <tr>
          <td class="bg-success" style="vertical-align:middle;">Dominika Cibulkova</td>
          <td class="bg-success text-center" style="vertical-align:middle; padding: 3px 1px;"><button class="btn btn-primary btn-block" data-toggle="modal" data-target="#modal-bet" data-whatever="player1" data-player="Damir Dzumhur">BET</button></td>
        </tr>

      </table>
    </div><!-- table-responsive -->
  </div>

            <!-- 2.モーダルの配置 -->
            <div class="modal" id="modal-bet" tabindex="-1">
                <div class="modal-dialog modal-dialog-center">
                    <!-- 3.モーダルのコンテンツ -->
                    <div class="modal-content">
                        <!-- 4.モーダルのヘッダ -->
                        <!--
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" id="modal-label"></h4>
                        </div>
                        -->
                        <!-- 5.モーダルのボディ -->
                        <div class="modal-body">
                            <span id="bet_player" class="text-primary"></span><br>
                            Match Winner<br>
                            Kei Nishikori vs Yuichi Sugita<br>
                            100 ポイント
                        </div>
                        <!-- 6.モーダルのフッタ -->
                        <div class="modal-footer" style="text-align:center;">
                            <button type="button" class="btn btn-default" data-dismiss="modal" id="bet_cancel">Cancel</button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal" id="bet_yes">BET</button>
                        </div>
                    </div>
                </div>
            </div>


         <!-- hidden -->
         <div id="hiddendiv">
           <form id="hiddenform" action="/TS/bet" method="GET">
             <input id="bet_player_id" name="bet_player_id" type="hidden" value=""/>
             <input id="bet_usre_id" name="bet_user_id" type="hidden" value="<%= locals.inputId %>"/>
             <input id="bet_point" name="bet_point" type="hidden" value="100"/>
           </form>
         </div>

<script type="text/javascript">
$(document).ready(function(){
  $('#modal-bet').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget); //モーダルを呼び出すときに使われたボタンを取得
    var player = button.data('player'); //data-player の値を取得

    var modal = $(this);  //モーダルを取得
    var modaltxt = modal.find('#bet_player'); //spanタグに表示
    $(modaltxt).text(player);
    
    var bet_player_id = button.data('whatever');
    $("#bet_player_id").attr("value",bet_player_id);
  });

  $('#bet_yes').on('click',function(){
    $('#hiddenform').submit();
  });

    $('#hiddenform').submit(function(event){
      // HTMLでの送信をキャンセル
      event.preventDefault();
   
      // 操作対象のフォーム要素を取得
      var $form = $(this);
   
      // 送信ボタンを取得
      var $button = $('#bet_yes');
      var $button_cancel = $('#bet_cancel');

      var player_id = $('#bet_player_id').val();

      // 送信
      $.ajax({
          url: 'bet/'+player_id,
          //url: $form.attr('action'),
          type: $form.attr('method'),
          //data: $form.serialize(),
          timeout: 10000,  // 単位はミリ秒
   
          // 送信前
          beforeSend: function(xhr, settings) {
              // ボタンを無効化し、二重送信を防止
              $button.attr('disabled', true);
              $button_cancel.attr('disabled', true);
          },
          // 応答後
          complete: function(xhr, textStatus) {
              // ボタンを有効化し、再送信を許可
              $button.attr('disabled', false);
              $button_cancel.attr('disabled', false);
          },
   
          // 通信成功時の処理
          success: function(result, textStatus, xhr) {
              // 入力値を初期化
              $form[0].reset();
               
              console.log('OK');
              console.log(result);

              $('#modal-bet').modal('hide');
              loadPoints();
              $('#alert').show();
              //location.reload(); //リロード
          },
   
          // 通信失敗時の処理
          error: function(xhr, textStatus, error) {
              console.log('NG...');
              console.log(xhr);
              console.log(textStatus);
              console.log(error);

              $('#modal-bet').modal('hide');
              loadPoints();
              $('#alert_error').show();
          }
      });
    });
});
  </script>



<footer></footer>

</body>
</html>
